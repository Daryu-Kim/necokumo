<template>
  <div class="login-container">
    <img src="@/assets/logo.png" alt="Logo" />
    <div>
      <h2>ê¸°ë³¸ ì •ë³´</h2>
      <div class="form">
        <h4 style="text-align: start">
          <span style="color: #007bff; margin-right: 8px">*</span>ì´ë©”ì¼
        </h4>
        <input
          type="email"
          v-model="email"
          required
          :disabled="emailVerified"
          style="margin-top: 4px"
          placeholder="ì‚¬ìš©í•˜ì‹¤ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”."
        />
        <button @click="verifyEmail" :disabled="emailVerified">
          ì´ë©”ì¼ ì¤‘ë³µí™•ì¸
        </button>
      </div>
      <div class="form">
        <h4 style="text-align: start">
          <span style="color: #007bff; margin-right: 8px">*</span>ë¹„ë°€ë²ˆí˜¸
        </h4>
        <input
          type="password"
          v-model="password"
          required
          style="margin-top: 4px"
          placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
        />
      </div>
      <div class="form">
        <h4 style="text-align: start">
          <span style="color: #007bff; margin-right: 8px">*</span>ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        </h4>
        <input
          type="password"
          v-model="retryPassword"
          required
          style="margin-top: 4px"
          placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œ ë²ˆ ë” ì…ë ¥í•˜ì„¸ìš”."
        />
      </div>
      <div class="form">
        <h4 style="text-align: start">
          <span style="color: #007bff; margin-right: 8px">*</span>ì´ë¦„
        </h4>
        <input
          type="text"
          v-model="name"
          required
          placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."
        />
      </div>
      <div class="form address-container">
        <h4 style="text-align: start">
          <span style="color: #007bff; margin-right: 8px">*</span>ì£¼ì†Œ
        </h4>
        <button @click="searchPostCode" style="margin-top: 12px">
          ì£¼ì†Œ ê²€ìƒ‰í•˜ê¸°
        </button>
        <input
          type="text"
          v-model="postCode"
          required
          disabled
          placeholder="ìš°í¸ë²ˆí˜¸"
        />
        <input
          type="text"
          v-model="address1"
          disabled
          required
          placeholder="ê¸°ë³¸ ì£¼ì†Œ"
        />
        <input
          type="text"
          v-model="address2"
          placeholder="ë‚˜ë¨¸ì§€ ì£¼ì†Œ (ì„ íƒ ì…ë ¥ ê°€ëŠ¥)"
        />
      </div>
      <div class="form">
        <h4 style="text-align: start">
          <span style="color: #007bff; margin-right: 8px">*</span>íœ´ëŒ€ì „í™”
        </h4>
        <input
          type="tel"
          v-model="phone"
          required
          placeholder="íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ex. 010-1234-5678)"
        />
      </div>
      <h2 style="margin-top: 36px">ì¶”ê°€ ì •ë³´</h2>
      <div class="form">
        <h4 style="text-align: start">
          <span style="color: #007bff; margin-right: 8px">*</span>ì„±ë³„
        </h4>
        <div>
          <div>
            <input
              type="radio"
              id="male"
              v-model="gender"
              name="gender"
              value="ë‚¨"
              required
            />
            <label for="male">ë‚¨ì</label>
          </div>
          <div>
            <input
              type="radio"
              id="female"
              v-model="gender"
              name="gender"
              value="ì—¬"
              required
            />
            <label for="female">ì—¬ì</label>
          </div>
        </div>
      </div>
      <div class="form">
        <h4 style="text-align: start">
          <span style="color: #007bff; margin-right: 8px">*</span>ìƒë…„ì›”ì¼
        </h4>
        <input type="date" v-model="birthday" required />
      </div>
      <div class="form">
        <h4 style="text-align: start">
          <span style="color: #007bff; margin-right: 8px">*</span>
          ì´ìš©ì¤‘ì¸ í†µì‹ ì‚¬
        </h4>
        <div>
          <div>
            <input
              type="radio"
              id="SKT"
              v-model="carrier"
              name="carrier"
              value="SKT"
              required
            />
            <label for="SKT">SKT</label>
          </div>
          <div>
            <input
              type="radio"
              id="KT"
              v-model="carrier"
              name="carrier"
              value="KT"
              required
            />
            <label for="KT">KT</label>
          </div>
          <div>
            <input
              type="radio"
              id="LGU+"
              v-model="carrier"
              name="carrier"
              value="LG U+"
              required
            />
            <label for="LGU+">LG U+</label>
          </div>
          <div>
            <input
              type="radio"
              id="SKT_1"
              v-model="carrier"
              name="carrier"
              value="SKT ì•Œëœ°í°"
              required
            />
            <label for="SKT_1">SKT ì•Œëœ°í°</label>
          </div>
          <div>
            <input
              type="radio"
              id="KT_1"
              v-model="carrier"
              name="carrier"
              value="KT ì•Œëœ°í°"
              required
            />
            <label for="KT_1">KT ì•Œëœ°í°</label>
          </div>
          <div>
            <input
              type="radio"
              id="LGU+_1"
              v-model="carrier"
              name="carrier"
              value="LG U+ ì•Œëœ°í°"
              required
            />
            <label for="LGU+_1">LG U+ ì•Œëœ°í°</label>
          </div>
        </div>
      </div>
      <div class="form">
        <h4 style="text-align: start">ì¶”ì²œì¸ ì´ë©”ì¼</h4>
        <input
          type="email"
          v-model="referral"
          placeholder="ì¶”ì²œì¸ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”."
          :disabled="referralVerified"
        />
        <button @click="verifyReferral" :disabled="referralVerified">
          ì¶”ì²œì¸ í™•ì¸
        </button>
      </div>
      <div class="form">
        <h4 style="text-align: start">
          <span style="color: #007bff; margin-right: 8px">*</span>
          í™˜ë¶ˆê³„ì¢Œ ì •ë³´
        </h4>
        <input type="text" v-model="refundName" required placeholder="ì˜ˆê¸ˆì£¼" />
        <input type="text" v-model="refundBank" required placeholder="ì€í–‰ëª…" />
        <input
          type="text"
          v-model="refundAccount"
          required
          placeholder="ê³„ì¢Œë²ˆí˜¸ ('-'ì™€ ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”)"
        />
      </div>
      <button @click="join">ê°€ì…í•˜ê¸°</button>
    </div>
  </div>
</template>

<script setup>
import { computed, ref } from "vue";
import { auth, db } from "@/lib/firebase";
import { useRouter } from "vue-router";
import {
  arrayUnion,
  collection,
  doc,
  getDocs,
  query,
  setDoc,
  updateDoc,
  where,
} from "firebase/firestore";
import { createUserWithEmailAndPassword } from "firebase/auth";

const email = ref("");
const emailVerified = ref(false);
const password = ref("");
const retryPassword = ref("");
const name = ref("");
const postCode = ref("");
const address1 = ref("");
const address2 = ref("");
const phone = ref("");
const gender = ref("");
const birthday = ref("");
const carrier = ref("");
const referral = ref("");
const referralVerified = ref(false);
const refundName = ref("");
const refundBank = ref("");
const refundAccount = ref("");

const router = useRouter();

const joinVerified = computed(
  () =>
    email.value &&
    emailVerified.value == true &&
    password.value &&
    retryPassword.value &&
    name.value &&
    postCode.value &&
    address1.value &&
    address2.value &&
    phone.value &&
    gender.value &&
    birthday.value &&
    carrier.value &&
    refundName.value &&
    refundBank.value &&
    refundAccount.value
);

const verifyEmail = async () => {
  try {
    if (!email.value.length > 0) {
      alert("ì‚¬ìš©í•˜ì‹¤ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      return;
    }

    if (!email.value.includes("@")) {
      alert("ì´ë©”ì¼ í˜•ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤!");
      return;
    }

    const doc = await getDocs(
      query(collection(db, "users"), where("userEmail", "==", email.value))
    );
    if (doc.size > 0) {
      alert("ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤!");
      emailVerified.value = false;
    } else {
      alert("ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤!");
      emailVerified.value = true;
    }
  } catch (error) {
    console.error("Error verifying email:", error);
  }
};

const verifyReferral = async () => {
  try {
    if (!referral.value.length > 0) {
      alert("ì¶”ì²œì¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      return;
    }

    if (!referral.value.includes("@")) {
      alert("ì´ë©”ì¼ í˜•ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤!");
      return;
    }

    const doc = await getDocs(
      query(collection(db, "users"), where("userEmail", "==", referral.value))
    );
    if (doc.size > 0) {
      alert("ì¶”ì²œì¸ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
      referralVerified.value = true;
    } else {
      alert("ê°€ì…ëœ ì¶”ì²œì¸ì´ ì—†ìŠµë‹ˆë‹¤!");
      referralVerified.value = false;
    }
  } catch (error) {
    console.error("Error verifying referral:", error);
  }
};

function searchPostCode() {
  new window.daum.Postcode({
    oncomplete: function (data) {
      var roadAddr = data.roadAddress;
      var extraRoadAddr = "";
      if (data.bname !== "" && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) {
        extraRoadAddr += data.bname;
      }
      if (data.buildingName !== "" && data.apartment === "Y") {
        extraRoadAddr +=
          extraRoadAddr !== "" ? ", " + data.buildingName : data.buildingName;
      }
      if (extraRoadAddr !== "") {
        extraRoadAddr = " (" + extraRoadAddr + ")";
      }

      postCode.value = data.zonecode;
      address1.value = roadAddr;
      address2.value = roadAddr ? extraRoadAddr : "";
    },
  }).open();
}

const join = async () => {
  if (password.value !== retryPassword.value) {
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!");
    return;
  }

  if (joinVerified.value == false) {
    alert("ì…ë ¥í•˜ì§€ ì•Šì€ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤!");
    return;
  }

  try {
    const userCredential = await createUserWithEmailAndPassword(
      auth,
      email.value,
      password.value
    );
    if (userCredential.user) {
      const userId = userCredential.user.uid;
      await setDoc(doc(db, "users", userId), {
        userId: email.value.split("@")[0],
        userEmail: email.value,
        userName: name.value,
        userBirthday: birthday.value,
        userGender: gender.value,
        userCarrier: carrier.value,
        userPhone: phone.value.replaceAll("-", ""),
        userGrade: "ğŸŒ± ì†œí„¸ëƒ¥ì´",
        userPostCode: postCode.value,
        userAddress1: address1.value,
        userAddress2: address2.value,
        userActualPaymentAmount: 0,
        userTotalOrdersCount: 0,
        userAvailableReservesAmount: 0,
        userTotalUsedReservesAmount: 0,
        userTotalReservesAmount: 0,
        userReferral: referral.value,
        userReferralList: [],
        userRefundAccount: `${
          refundBank.value
        }/${refundAccount.value.replaceAll("-", "")}/${refundName.value}`,
        createdAt: new Date(),
        isAdmin: false,
      });
      const referralUserDocs = await getDocs(
        query(collection(db, "users"), where("userEmail", "==", referral.value))
      );
      const referralUserDoc = referralUserDocs.docs[0];
      await updateDoc(referralUserDoc.ref, {
        userReferralList: arrayUnion(email.value),
      });
      alert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
      router.push("/");
    }
  } catch (error) {
    console.error("Error creating user:", error);
    alert("íšŒì›ê°€ì… ì˜¤ë¥˜ì…ë‹ˆë‹¤! ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.");
  }
};
</script>

<style scoped lang="scss">
.login-container {
  max-width: 480px;
  margin: 0 auto;
  min-height: 50vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
  border-radius: 8px;
  background-color: #fff;
  text-align: center;

  > img {
    width: 192px;
  }

  > div {
    margin-top: 48px;
    width: 100%;

    > h2 {
      padding-bottom: 24px;
    }

    .form:not(:first-child) {
      margin-top: 24px;
    }

    .form {
      > div {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        margin-top: 12px;
        > div {
          display: flex;
          align-items: center;
          gap: 4px;
          > input {
            width: 20px;
            height: 20px;
          }

          > label {
            font-size: 14px;
          }
        }
      }

      > button {
        padding: 12px 16px;
        font-size: 16px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        font-weight: 700;

        &:hover {
          background-color: #0069d9;
        }

        &:disabled {
          background-color: #999;
          cursor: not-allowed;
        }
      }
    }

    .form > input {
      padding: 8px;
      width: 100%;
      border: none;
      border-bottom: 1.5px solid #ccc;
      margin-bottom: 8px;
      margin-top: 4px;
      font-size: 16px;

      &:focus {
        outline: none;
        border-bottom-color: #007bff;
      }
    }

    > button {
      margin-top: 36px;
      padding: 12px 16px;
      font-size: 16px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      font-weight: 700;

      &:hover {
        background-color: #0069d9;
      }
    }
  }
}
</style>
