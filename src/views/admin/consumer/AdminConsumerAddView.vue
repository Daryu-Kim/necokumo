<template>
  <div class="admin-consumer-add">
    <h2>{{ isReplace ? "íšŒì› ì •ë³´ ìˆ˜ì •í•˜ê¸°" : "íšŒì› ì •ë³´ ë“±ë¡í•˜ê¸°" }}</h2>
    <div class="add-box">
      <h3>ê¸°ë³¸ ì •ë³´</h3>
      <div>
        <h4>ìœ ì € ID</h4>
        <input
          type="text"
          v-model="userData.userId"
          maxlength="16"
          placeholder="8 ~ 16ìì˜ ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¤‘ 1ê°€ì§€ ì´ìƒ"
          :disabled="isReplace"
        />
      </div>
      <div>
        <h4>ìœ ì € E-Mail</h4>
        <input
          type="email"
          v-model="userData.userEmail"
          placeholder="ì‹¤ì œ ì‚¬ìš©ì¤‘ì¸ ìœ ì €ì˜ E-Mail ì£¼ì†Œ"
          :disabled="isReplace"
        />
      </div>
      <div v-if="!isReplace">
        <h4>ìœ ì € ë¹„ë°€ë²ˆí˜¸</h4>
        <input
          type="password"
          v-model="userPassword"
          placeholder="8 ~ 20ìì˜ ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¤‘ 2ê°€ì§€ ì´ìƒ (ì„¤ì •í•˜ì§€ ì•Šì„ ì‹œ íœ´ëŒ€í° ë²ˆí˜¸ë¡œ ì„¤ì •)"
        />
      </div>
      <div v-if="!isReplace">
        <h4>ìœ ì € ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥</h4>
        <input
          type="password"
          v-model="userRePassword"
          placeholder="ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"
        />
      </div>
      <div>
        <h4>ìœ ì € ì´ë¦„</h4>
        <input
          type="text"
          v-model="userData.userName"
          placeholder="ì‹ ë¶„ì¦ ê¸°ì¬ ìƒ ì´ë¦„ ì…ë ¥"
        />
      </div>
      <div>
        <h4>ìœ ì € ì£¼ì†Œ</h4>
        <div class="address-container">
          <div>
            <input
              type="text"
              v-model="userData.userPostCode"
              disabled
              placeholder="00000"
            />
            <button @click="openAddressPopup()">ì£¼ì†Œê²€ìƒ‰</button>
          </div>
          <input
            type="text"
            v-model="userData.userAddress1"
            disabled
            placeholder="ì£¼ì†Œ ê²€ìƒ‰ì„ ì‚¬ìš©í•˜ì„¸ìš”."
          />
          <input
            type="text"
            v-model="userData.userAddress2"
            placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì•„íŒŒíŠ¸, ë™/í˜¸ìˆ˜ ë“±)"
          />
        </div>
      </div>
    </div>
    <div class="add-box">
      <h3>ì¶”ê°€ ì •ë³´</h3>
      <div>
        <h4>ìœ ì € ì„±ë³„</h4>
        <div class="radio-box">
          <div>
            <input
              name="gender"
              id="male"
              type="radio"
              value="ë‚¨"
              v-model="userData.userGender"
              :disabled="isReplace"
            />
            <label for="male">ë‚¨ì</label>
          </div>
          <div>
            <input
              name="gender"
              id="female"
              type="radio"
              value="ì—¬"
              v-model="userData.userGender"
              :disabled="isReplace"
            />
            <label for="female">ì—¬ì</label>
          </div>
        </div>
      </div>
      <div>
        <h4>ìœ ì € ìƒë…„ì›”ì¼</h4>
        <input
          type="date"
          v-model="userData.userBirthday"
          :disabled="isReplace"
        />
      </div>
      <div>
        <h4>ìœ ì € í†µì‹ ì‚¬</h4>
        <div class="radio-box">
          <div>
            <input
              name="carrier"
              id="SKT"
              type="radio"
              value="SKT"
              v-model="userData.userCarrier"
            />
            <label for="SKT">SKT</label>
          </div>
          <div>
            <input
              name="carrier"
              id="KT"
              type="radio"
              value="KT"
              v-model="userData.userCarrier"
            />
            <label for="KT">KT</label>
          </div>
          <div>
            <input
              name="carrier"
              id="LGU"
              type="radio"
              value="LG U+"
              v-model="userData.userCarrier"
            />
            <label for="LGU">LG U+</label>
          </div>
          <div>
            <input
              name="carrier"
              id="SKT2"
              type="radio"
              value="SKT ì•Œëœ°í°"
              v-model="userData.userCarrier"
            />
            <label for="SKT2">SKT ì•Œëœ°í°</label>
          </div>
          <div>
            <input
              name="carrier"
              id="KT2"
              type="radio"
              value="KT ì•Œëœ°í°"
              v-model="userData.userCarrier"
            />
            <label for="KT2">KT ì•Œëœ°í°</label>
          </div>
          <div>
            <input
              name="carrier"
              id="LGU2"
              type="radio"
              value="LG U+ ì•Œëœ°í°"
              v-model="userData.userCarrier"
            />
            <label for="LGU2">LG U+ ì•Œëœ°í°</label>
          </div>
        </div>
      </div>
      <div>
        <h4>ìœ ì € íœ´ëŒ€í°ë²ˆí˜¸</h4>
        <input
          type="phone"
          v-model="userData.userPhone"
          placeholder="'-' ì—†ì´ ìˆ«ìë§Œ ì…ë ¥"
          @input="
            (e) =>
              (userData.userPhone = e.target.value
                .replace(/[^0-9]/g, '')
                .slice(0, 11))
          "
        />
      </div>
      <div>
        <h4>ìœ ì € í™˜ë¶ˆê³„ì¢Œ</h4>
        <div class="refund-container">
          <select v-model="userRefundAccount[0]">
            <option value="">ì„ íƒ</option>
            <option
              v-for="(item, index) in bankNames"
              :key="index"
              :value="item"
            >
              {{ item }}
            </option>
          </select>
          <input
            type="text"
            placeholder="ê³„ì¢Œë²ˆí˜¸ ì…ë ¥"
            v-model="userRefundAccount[1]"
            @input="
              (e) =>
                (userRefundAccount[1] = e.target.value.replace(/[^0-9]/g, ''))
            "
          />
          <input
            type="text"
            placeholder="ì˜ˆê¸ˆì£¼ëª…"
            v-model="userRefundAccount[2]"
          />
        </div>
      </div>
      <div>
        <h4>ìœ ì € ì¶”ì²œì¸ ì•„ì´ë””</h4>
        <input
          type="text"
          v-model="userData.userReferralId"
          placeholder="ì¶”ì²œì¸ ì•„ì´ë”” ì…ë ¥ (ì˜ë¬¸, ìˆ«ìë§Œ ì…ë ¥)"
        />
      </div>
    </div>
    <div class="button-box">
      <button @click="confirmUserData" :disabled="isBusy">
        {{ isReplace ? "íšŒì› ì •ë³´ ìˆ˜ì •í•˜ê¸°" : "íšŒì› ì •ë³´ ë“±ë¡í•˜ê¸°" }}
      </button>
    </div>
  </div>
</template>

<script setup>
import { auth, db } from "@/lib/firebase";
import router from "@/router";
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
} from "firebase/auth";
import {
  arrayUnion,
  collection,
  doc,
  getDoc,
  getDocs,
  query,
  setDoc,
  Timestamp,
  updateDoc,
  where,
} from "firebase/firestore";
import { nextTick, onMounted, ref } from "vue";
import { useRoute } from "vue-router";

const isBusy = ref(false);
const isReplace = ref(false);
const userData = ref({});
const route = useRoute();

const userPassword = ref("");
const userRePassword = ref("");
const userRefundAccount = ref([""]);

const bankNames = [
  "ê²½ë‚¨ì€í–‰",
  "ê´‘ì£¼ì€í–‰",
  "ë‹¨ìœ„ë†í˜‘(ì§€ì—­ë†ì¶•í˜‘)",
  "ë¶€ì‚°ì€í–‰",
  "ìƒˆë§ˆì„ê¸ˆê³ ",
  "ì‚°ë¦¼ì¡°í•©",
  "ì‹ í•œì€í–‰",
  "ì‹ í˜‘",
  "ì”¨í‹°ì€í–‰",
  "ìš°ë¦¬ì€í–‰",
  "ìš°ì²´êµ­ì˜ˆê¸ˆë³´í—˜",
  "ì €ì¶•ì€í–‰ì¤‘ì•™íšŒ",
  "ì „ë¶ì€í–‰",
  "ì œì£¼ì€í–‰",
  "ì¹´ì¹´ì˜¤ë±…í¬",
  "ì¼€ì´ë±…í¬",
  "í† ìŠ¤ë±…í¬",
  "í•˜ë‚˜ì€í–‰",
  "í™ì½©ìƒí•˜ì´ì€í–‰",
  "IBKê¸°ì—…ì€í–‰",
  "KBêµ­ë¯¼ì€í–‰",
  "iMë±…í¬(ëŒ€êµ¬)",
  "í•œêµ­ì‚°ì—…ì€í–‰",
  "NHë†í˜‘ì€í–‰",
  "SCì œì¼ì€í–‰",
  "Shìˆ˜í˜‘ì€í–‰",
  "êµë³´ì¦ê¶Œ",
  "ëŒ€ì‹ ì¦ê¶Œ",
  "ë©”ë¦¬ì¸ ì¦ê¶Œ",
  "ë¯¸ë˜ì—ì…‹ì¦ê¶Œ",
  "ë¶€êµ­ì¦ê¶Œ",
  "ì‚¼ì„±ì¦ê¶Œ",
  "ì‹ ì˜ì¦ê¶Œ",
  "ì‹ í•œê¸ˆìœµíˆ¬ì",
  "ìœ ì•ˆíƒ€ì¦ê¶Œ",
  "ìœ ì§„íˆ¬ìì¦ê¶Œ",
  "ì¹´ì¹´ì˜¤í˜ì´ì¦ê¶Œ",
  "í‚¤ì›€ì¦ê¶Œ",
  "í† ìŠ¤ë¨¸ë‹ˆ",
  "í† ìŠ¤ì¦ê¶Œ",
  "í€ë“œì˜¨ë¼ì¸ì½”ë¦¬ì•„(í•œêµ­í¬ìŠ¤ì¦ê¶Œ)",
  "í•˜ë‚˜ê¸ˆìœµíˆ¬ì",
  "ì•„ì´ì— ì¦ê¶Œ",
  "í•œêµ­íˆ¬ìì¦ê¶Œ",
  "í•œí™”íˆ¬ìì¦ê¶Œ",
  "í˜„ëŒ€ì°¨ì¦ê¶Œ",
  "DBê¸ˆìœµíˆ¬ì",
  "KBì¦ê¶Œ",
  "KTBíˆ¬ìì¦ê¶Œ(ë‹¤ì˜¬íˆ¬ìì¦ê¶Œ)",
  "LIGíˆ¬ìì¦ê¶Œ",
  "NHíˆ¬ìì¦ê¶Œ",
  "SKì¦ê¶Œ",
];

async function confirmUserData() {
  try {
    if (
      userData.value.userId === "" ||
      userData.value.userEmail === "" ||
      userData.value.userName === "" ||
      userData.value.userPostCode === "" ||
      userData.value.userAddress1 === "" ||
      userData.value.userGender === "" ||
      userData.value.userBirthday === "" ||
      userData.value.userCarrier === "" ||
      userData.value.userPhone === "" ||
      userRefundAccount.value[0] === "" ||
      userRefundAccount.value[1] === "" ||
      userRefundAccount.value[2] === ""
    ) {
      alert("ëˆ„ë½ëœ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    if (!isReplace.value) {
      if (userPassword.value !== userRePassword.value) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!");
        return;
      }

      const duplicatedUserId = await getDocs(
        query(
          collection(db, "users"),
          where("userId", "==", userData.value.userId)
        )
      );

      if (duplicatedUserId.docs.length > 0) {
        alert("ì¤‘ë³µëœ ì•„ì´ë””ê°€ ìˆìŠµë‹ˆë‹¤!");
        return;
      }

      const duplicatedUserEmail = await getDocs(
        query(
          collection(db, "users"),
          where("userEmail", "==", userData.value.userEmail)
        )
      );

      if (duplicatedUserEmail.docs.length > 0) {
        alert("ì¤‘ë³µëœ ì´ë©”ì¼ì´ ìˆìŠµë‹ˆë‹¤!");
        return;
      }

      if (userData.value.userReferralId.length > 0) {
        const existReferralUserId = await getDocs(
          query(
            collection(db, "users"),
            where("userId", "==", userData.value.userReferralId)
          )
        );

        if (existReferralUserId.docs.length === 0) {
          alert("ì…ë ¥í•˜ì‹  ì¶”ì²œì¸ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!");
          return;
        }
      }

      if (userPassword.value.length === 0) {
        userPassword.value = userData.value.userPhone;
      }
    }

    if (!isReplace.value) {
      const originalUserUid = auth.currentUser.uid;
      await signOut(auth);

      const userCredential = await createUserWithEmailAndPassword(
        auth,
        userData.value.userEmail,
        userPassword.value
      );

      userData.value.userAge =
        new Date().getFullYear() -
        parseInt(userData.value.userBirthday.slice(0, 4)) +
        1;
      userData.value.userGrade = "ğŸŒ± ì†œí„¸ëƒ¥ì´";
      userData.value.userActualPaymentAmount = 0;
      userData.value.userTotalActualOrderCount = 0;
      userData.value.userAvailablePoint = 0;
      userData.value.userTotalUsedPoint = 0;
      userData.value.userTotalPoint = 0;
      userData.value.userRefundAccount = userRefundAccount.value.join("/");
      userData.value.createdAt = Timestamp.fromDate(new Date());
      userData.value.isAdmin = false;

      await setDoc(doc(db, "users", userCredential.user.uid), userData.value);

      if (userData.value.userReferralId.length > 0) {
        const referralUserDoc = (
          await getDocs(
            query(
              collection(db, "users"),
              where("userId", "==", userData.value.userReferralId)
            )
          )
        ).docs[0];
        await updateDoc(doc(db, "users", referralUserDoc.id), {
          userReferralList: arrayUnion(userData.value.userId),
        });
      }

      await signOut(auth);

      const originalUser = (
        await getDoc(doc(db, "users", originalUserUid))
      ).data();
      await signInWithEmailAndPassword(
        auth,
        originalUser.userEmail,
        originalUser.userPassword
      );
    } else {
      const userRef = doc(db, "users", route.query.id);
      userData.value.userRefundAccount = [
        userRefundAccount.value[0], // ì€í–‰ëª…
        userRefundAccount.value[1].replace(/-/g, ""), // ê³„ì¢Œë²ˆí˜¸ì—ì„œ '-' ì œê±°
        userRefundAccount.value[2], // ì˜ˆê¸ˆì£¼ëª…
      ].join("/");
      await updateDoc(userRef, userData.value);

      const referralUserDoc = (
        await getDocs(
          query(
            collection(db, "users"),
            where("userId", "==", userData.value.userReferralId)
          )
        )
      ).docs[0];
      await updateDoc(doc(db, "users", referralUserDoc.id), {
        userReferralList: arrayUnion(userData.value.userId),
      });
    }

    alert("ë³€ê²½ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    router.replace("/admin/consumer/list");
  } catch (error) {
    console.error("Error updating user data: ", error);
  }
}

async function openAddressPopup() {
  new window.daum.Postcode({
    oncomplete: function (data) {
      let fullAddress = data.address; // ë„ë¡œëª… or ì§€ë²ˆ ì£¼ì†Œ
      let extraAddress = ""; // ê±´ë¬¼ëª…, ë²•ì •ë™ ë“±
      let defaultDetail = ""; // address2ì— ë„£ì„ ê¸°ë³¸ê°’

      // ë„ë¡œëª… ì£¼ì†Œì¼ ê²½ìš° ë¶€ê°€ì •ë³´ ì¡°í•©
      if (data.addressType === "R") {
        if (data.bname) extraAddress += data.bname;
        if (data.buildingName) {
          extraAddress += (extraAddress ? ", " : "") + data.buildingName;
        }
      }

      if (extraAddress) {
        defaultDetail = `(${extraAddress})`; // ì˜ˆ: "ì—­ì‚¼ë™, ì‚¼ì„±ë¹Œë”©"
      }

      // Vue ë°ì´í„°ì— ë°˜ì˜
      userData.value.userPostCode = data.zonecode;
      userData.value.userAddress1 = fullAddress;
      userData.value.userAddress2 = defaultDetail; // ì—¬ê¸°ì— ìë™ ê¸°ë³¸ê°’ ì…ë ¥!

      // ìƒì„¸ ì£¼ì†Œ input í¬ì»¤ì‹±
      nextTick(() => {
        document.getElementById("address2")?.focus();
      });
    },
  }).open();
}

onMounted(async () => {
  try {
    const query = route.query.id || null;
    if (query) {
      const data = await (await getDoc(doc(db, "users", query))).data();
      userData.value = data;
      userRefundAccount.value = data.userRefundAccount.split("/");
      isReplace.value = true;
    }
  } catch (error) {
    console.error(error);
    isBusy.value = false;
  }
});
</script>

<style scoped lang="scss">
.admin-consumer-add {
  margin-top: 36px;

  > .add-box {
    margin-top: 24px;
    box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.25);
    border-radius: 8px;
    padding: 24px;

    > div {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;

      > h4 {
        width: 160px;
        border-right: 1px solid rgba(0, 0, 0, 0.25);
      }

      > input,
      textarea {
        flex: 1;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        background-color: #efefef;
        font-size: 14px;

        ::placeholder {
          color: rgba(0, 0, 0, 0.6);
        }

        &:focus {
          outline: 2px solid #007bff;
        }
      }

      > .radio-box {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
        > div {
          margin: 0;
          display: flex;
          align-items: center;
          > input {
            width: 20px;
            height: 20px;
          }
          > label {
            font-size: 14px;
          }
        }
      }

      > .refund-container {
        display: flex;
        align-items: center;
        gap: 16px;

        > input,
        select {
          width: 100%;
          padding: 8px 12px;
          border-radius: 4px;
          border: none;
          box-sizing: border-box;
          outline: none;
          font-size: 14px;
          background-color: #efefef;
        }
      }

      > .address-container {
        display: flex;
        flex-direction: column;
        gap: 8px;

        > div {
          display: flex;
          align-items: center;
          gap: 8px;

          > input {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            box-sizing: border-box;
            outline: none;
            font-size: 14px;
            background-color: #efefef;
          }

          > button {
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            height: 34px;
            padding: 8px 16px;
          }
        }

        > input {
          width: 100%;
          padding: 8px 12px;
          border: none;
          border-radius: 4px;
          box-sizing: border-box;
          outline: none;
          font-size: 14px;
        }
      }

      > span {
        font-size: 14px;
      }

      > div {
        flex: 1;
        > input,
        textarea {
          width: 100%;
          padding: 8px 12px;
          border: none;
          border-radius: 4px;
          background-color: #efefef;
          font-size: 14px;

          ::placeholder {
            color: rgba(0, 0, 0, 0.6);
          }

          &:focus {
            outline: 2px solid #007bff;
          }
        }

        > div {
          margin-top: 8px;
          display: flex;
          align-items: center;
          gap: 8px;

          > button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: #fff;
            font-size: 14px;
            cursor: pointer;

            &:hover {
              background-color: #0069d9;
            }

            &:disabled {
              cursor: not-allowed;
              background-color: #efefef;
              color: rgba($color: #000000, $alpha: 0.5);
            }
          }
        }
      }
    }
  }

  > .button-box {
    margin-top: 36px;
    display: flex;
    align-items: center;
    justify-content: center;

    > button {
      border-radius: 4px;
      padding: 12px 24px;
      background-color: #007bff;
      border: none;
      color: #fff;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
    }
  }
}
</style>
